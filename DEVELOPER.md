# 上证50ETF期权量化大屏 - 开发者技术与算法原理白皮书

本文档面向对该衍生品量化大屏进行二次开发、算法重构的工程师与量化研究员。详细阐述了底层的纯数学逻辑与技术实现手段。

---

## 一、核心引擎与目录架构

项目极度内聚，数学计算核心被完全封装剥离，UI负责解耦呈现：
*   `app.py`: Streamlit 应用主干，负责数据 I/O 编排、异步状态缓存管理、Echarts 高级图形构建以及数据渲染器 (Dataframe Styler)。
*   `strategy/indicators.py`: 纯量化算法内核大类 `StrategyIndicators` 所在地。

### 核心数值体系依赖包:
*   **arch**: 实现多分布族 GARCH 波动预测的核心。
*   **statsmodels**: 执行时间序列高级分析，底层调用 `adfuller` 实现严谨单位根检验。
*   **scipy**: 操作极值分布的逆累积分布函数 (PPF)。

---

## 二、数学防雷区：三大核心指标的底层抽象

本策略是一段“在波动率悬崖边跳舞”的卖方算法逻辑，因此量化基柱构筑极为厚重。

### 2.1 泡沫发生器：向后极大右尾 ADF 检验 (BSADF)
**金融学动机**：资产价格如果在某段时间内出现远超指数增长的正反馈效应，传统单位根检验(ADF)难以实时追踪何时崩溃。BSADF (Backward Supremum ADF) 就是要在时序中寻找是否存在一个局部的爆炸性几何根 (Explosive Unit Root)。

**技术实现路径 (`calculate_bsadf` 方法)**：
1.  **序列转换**：将现货价格 $P_t$ 转化为自然对数价格序列 $p_t = \ln(P_t)$，捕捉对数价格发散。
2.  **动态窗口滑动测算**：
    设定最小滑窗 $r_0$ (100天)，当前节点 $t$。在 $t$ 之内，起始端点 $r_1$ 从 0 滑动到 $t-r_0$。
3.  **统计量构建**：对每一个子样本区间执行经典的 Augmented Dickey-Fuller 检验（包含常数与趋势项 `regression='ct'`）。
    $$ \Delta p_{\tau} = \alpha + \beta \tau + \gamma p_{\tau-1} + \sum_{k=1}^K \phi_k \Delta p_{\tau-k} + \varepsilon_\tau $$
    这里我们关注的是 $\gamma > 0$（爆炸性过程，右尾检验），有别于传统检验平稳性的左尾（$\gamma < 0$）。
4.  **上确界提取**：在所有滑动起点 $r_1$ 的 ADF-statistic (t-ratio) 结果中，提取最大值，即 $BSADF_t = \sup_{r_1} (ADF_{r_1}^{t})$。
5.  **信号发出**：当当期的 $BSADF_t$ 超越通过蒙特卡洛或近似公式拟合的临界值限界表 (Critical Value) 时（当前代码简化采用统计学经验判限：大于截距平滑线或者绝对值 > 1.5），大屏K线上方点亮警告性黄色“泡沫泡泡”，允许卖方机构入场布局收割。

### 2.2 防护穹顶：多重分布假定的 GARCH VaR 评估
**金融学动机**：传统历史波动率(HV)无法刻画金融市场的“波动率聚集”现象。我们要预测明天（T+1）到底会怎么波动，以挂出远离火线的极度虚值期权，并在破防之前认怂。

**技术实现路径 (`calculate_garch_var` 方法)**：
采用长周期窗（250天日线）进行对数收益率估计 $r_t = \ln(P_t / P_{t-1})$。核心在于求解波动率方差模型：
$$ \sigma_t^2 = \omega + \alpha_1 \varepsilon_{t-1}^2 + \beta_1 \sigma_{t-1}^2 $$
通过拟合，拿到模型对明天的预测方差 $\hat{\sigma}_{T+1}^2$。我们将并行展开三道分布防线（由松到紧）：
1.  **sGARCH_norm (正规军)**：`dist='Normal'`。假定收益率震荡遵循正态分布。利用 `stats.norm.ppf` 取 95% 与 99% 的距离极值。
2.  **sGARCH_skew (游击队防线)**：`dist='skewstudent'`。金融世界不是钟形曲线，而是“尖峰厚尾”。引入偏态斯图登特 t 分布 (Skewed t-distribution)，参数自动拟合其自由度 $\nu$ 与不对称系数 $\lambda$。得出的下行风险尾部比正规军宽敞很多。
3.  **sGARCH_jump (终极隔离墙)**：真实世界有停牌跳空等非连续布朗运动因素。严格理论需要套用 Merton 跳跃扩散，结合泊松概率叠加。本代码从实战性能出发，提取基础 GARCH 模型预测值，粗暴施加 1.3~1.4 的跳跃风险乘数溢价，强行扩充出最后的末日 VaR 99% 分位数。
*系统融合指令*：提取 `skew_95` 的预测震幅作为绝不能被打破的**绝对斩仓认怂线**。

### 2.3 盘中熔断阀门：日内年化 Realized Volatility (RV)
**金融学动机**：如果日线 GARCH 防御网在今天还没收盘前，盘中就已经发生千股跌停级别的黑天鹅巨浪怎么办？必须拥有日内的刻度雷达。

**技术实现路径 (`calculate_daily_rv` 方法)**：
1.  **高频抽样**：提取 5分钟 级别的盘中连续对数收益率 $r_{t, i}$。
2.  **单日累加平滑**：盘中已实现方差 $RV_t^2 = \sum_{i=1}^n r_{t,i}^2$。
3.  **年化投射**：$RV\_annualized = \sqrt{RV_t^2} \times \sqrt{250 \text{ 个交易日}}$（或根据高频频段补足常数乘子）。一旦这个盘中实时探测的 RV 超标，系统跳开隔夜评估，立刻指令离场。

---

## 三、UI 渲染器原理 (Streamlit + Pyecharts)

*   **Pyecharts 双图层重叠算法 (Overlap)**：
    为了将复杂的宏观数学指标具像化，我们在 K 线（`Kline` 实例）基础图层之上，将上文中提取出的时间轴完全对应的 $BSADF_t$ 数值序列进行遮罩判定 ($> cv$)。将所有不触发条件的刻度剔除为 `None`，触发暴跌/暴涨泡沫的时刻提取该日 K 线的最高价(High)并加高 1% 位置挂载一个 `Scatter` 实例点。
*   **Styler 响应式表格**：
    由于期权 T型报价是瞬间数据，`app.py` 内部运用了 pandas 的 `style.apply()`。遍历 DataFrame 中每一行，利用行内的【当前虚值深度%】字段与之前算出的系统变量 `var_95` 进行减法求差。根据这个**安全垫差额**的大小，动态灌入 CSS 渲染着色（如绿底大粗体提示非常安全，红底高危），使得交易员肉眼能够像玩射击游戏一样，快速找到“安全的高收益靶心合约”。
